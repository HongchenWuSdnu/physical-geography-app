<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>自然资源敏感分级合规平台</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,Helvetica,sans-serif;background:#f6f8fb;margin:0}
  header{background:#fff;border-bottom:1px solid #e6e9ee}
  .nav{display:flex;align-items:center;max-width:1260px;margin:0 auto;padding:0 24px}
  .nav-logo{font-weight:700;color:#165ba6;font-size:1.12em;margin-right:28px;display:flex;align-items:center}
  .nav-logo img{height:22px;margin-right:8px}
  .nav-tabs{display:flex;flex:1;flex-wrap:wrap}
  .nav-tabs a{display:block;color:#165ba6;text-decoration:none;padding:18px 18px 12px;border-bottom:3px solid transparent;transition:.17s;margin-right:4px;font-weight:600}
  .nav-tabs a.active,.nav-tabs a:hover{border-bottom:3px solid #f44336;background:#f7f9fa;color:#f44336}
  .container{max-width:1160px;margin:28px auto;background:#fff;border-radius:12px;box-shadow:0 2px 12px #0001;padding:24px 24px 28px;min-height:520px}
  .tab-content{display:none}.tab-content.active{display:block}
  .section-title{font-size:1.18em;font-weight:700;color:#165ba6;margin:1em 0 .5em}
  .form-block{background:#f3f6fa;border-radius:10px;padding:14px 16px;margin:12px 0}
  .form-block label{display:block;font-weight:600;margin:12px 0 6px}
  .form-inline{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{background:#165ba6;color:#fff;border:none;border-radius:8px;padding:9px 16px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#00a884}.btn.warn{background:#f44336}.btn.ghost{background:#eef3f8;color:#165ba6}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  input,select,textarea{font-size:1em}
  input[type="text"],input[type="number"],input[type="file"],select,textarea{width:100%;padding:8px 10px;border:1px solid #d2dbe5;border-radius:8px;box-sizing:border-box}
  .row{display:flex;gap:18px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .tip{color:#7b8696;font-size:.95em;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{border:1px solid #e2e7ef;padding:8px 10px;text-align:center}
  th{background:#f1f5fb}
  canvas{border:1px dashed #cfd7e6;border-radius:10px;max-width:100%;background:#fff}
  .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#eef3f8;border:1px solid #dfe6ef;font-size:.9em;color:#51607a}
  .ok{color:#0b7a0b}.err{color:#c62828}
  .footer{color:#7d8697;font-size:.95em;text-align:center;margin:18px 0}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <div class="nav-logo">
      <img src="https://cdn-icons-png.flaticon.com/512/3429/3429626.png" alt="logo" />
      自然资源敏感分级合规平台
    </div>
    <div class="nav-tabs">
      <a href="#home" class="active" onclick="showTab(event,'home')">平台首页</a>
      <a href="#rules" onclick="showTab(event,'rules')">规则库/版本校验</a>
      <a href="#judge" onclick="showTab(event,'judge')">分级判定</a>
      <a href="#blur" onclick="showTab(event,'blur')">高斯卷积模糊</a>
      <a href="#jitter" onclick="showTab(event,'jitter')">坐标扰动</a>
      <a href="#calendar" onclick="showTab(event,'calendar')">时间提醒</a>
      <a href="#ledger" onclick="showTab(event,'ledger')">台账/哈希链</a>
      <a href="#standard" onclick="showTab(event,'standard')">标准映射</a>
      <a href="#blockchain" onclick="showTab(event,'blockchain')">区块链存证</a>
      <span id="permitBadge" class="pill" title="门禁">Permit: 未认证 / -</span>
    </div>
  </nav>
</header>

<div class="container">

  <!-- 首页 -->
  <div class="tab-content active" id="home">
    <div class="section-title">平台简介</div>
    <p>本演示对应研究报告第七章的“自然资源地理信息安全管控与脱敏决策系统”，串联数据安全与防护、规则知识与控制、可信追溯与合规模块，形成“评估—处置—审计”闭环。</p>
    <div class="form-inline">
      <label>模拟用户国别：</label>
      <select id="selCountry" onchange="updatePermit()">
        <option value="">-</option><option value="CN">CN</option><option value="US">US</option><option value="XX">XX(受限)</option>
      </select>
      <label>认证状态：</label>
      <select id="selAuth" onchange="updatePermit()">
        <option value="0">未认证</option><option value="1">已认证</option>
      </select>
      <span class="tip">说明：Permit(u,c) 控制下载等敏感操作按钮可用性。</span>
    </div>
  </div>

  <!-- 规则库/版本校验 -->
  <div class="tab-content" id="rules">
    <div class="section-title">规则知识库与版本一致性校验</div>
    <div class="row">
      <div class="col">
        <div class="form-block">
          <div><b>当前版本：</b><span id="verText" class="pill">-</span></div>
          <div style="margin-top:6px"><b>SHA-256：</b><span id="verHash" class="pill">-</span></div>
          <div class="tip" id="verStatus">校验中…</div>
          <hr/>
          <label>阈值 T（R ≥ T 禁止流通）：</label>
          <input id="thresh" type="number" value="9" min="1" max="25" />
          <div class="form-inline">
            <button class="btn" onclick="toggleRuleEngine(true)">启用规则引擎</button>
            <button class="btn ghost" onclick="toggleRuleEngine(false)">停用规则引擎</button>
          </div>
          <div class="tip">状态：<span id="ruleState">未启用</span>。任务启动或参数变更时进行版本比对，保障规则一致。</div>
        </div>
      </div>
      <div class="col">
        <div class="form-block">
          <label>规则列表（示例）</label>
          <table id="ruleTable"><thead><tr><th>#</th><th>条件</th><th>动作</th><th>等级</th><th>优先级</th><th>启用</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- 分级判定 -->
  <div class="tab-content" id="judge">
    <div class="section-title">分级判定与自动脱敏入口</div>
    <div class="row">
      <div class="col">
        <div class="form-block">
          <label>空间分辨率(m)：</label>
          <select id="resSel"><option>0.3</option><option>1</option><option>5</option><option>10</option><option>30</option></select>
          <label>敏感等级（低敏感 / 中敏感 / 高敏感）：</label>
          <select id="sensSel">
            <option value="1">低敏感</option>
            <option value="2">中敏感</option>
            <option value="3">高敏感</option>
          </select>
          <div class="form-inline">
            <button class="btn" onclick="doJudge()">一键判定</button>
            <span id="judgeOut" class="pill">-</span>
          </div>
          <div class="tip">
            R = Rs × Sm（Sm=1/2/3 对应低/中/高敏感），阈值 T 在“规则库/版本校验”中调整；
            判定为“禁止流通”时应进入脱敏流程。
          </div>
        </div>
      </div>
      <div class="col">
        <div class="form-block">
          <label>样例矩阵（示意）</label>
          <table>
            <tr>
              <th>分辨率\\敏感等级</th>
              <th>低敏感（1）</th>
              <th>中敏感（2）</th>
              <th>高敏感（3）</th>
            </tr>
            <tr>
              <td>0.3</td>
              <td>1</td>
              <td>2</td>
              <td>3</td>
            </tr>
            <tr>
              <td>1</td>
              <td>2</td>
              <td>4</td>
              <td>6</td>
            </tr>
            <tr>
              <td>5</td>
              <td>3</td>
              <td>6</td>
              <td>9</td>
            </tr>
            <tr>
              <td>10</td>
              <td>4</td>
              <td>8</td>
              <td>12</td>
            </tr>
            <tr>
              <td>30</td>
              <td>5</td>
              <td>10</td>
              <td>15</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 高斯模糊 -->
  <div class="tab-content" id="blur">
    <div class="section-title">遥感影像高斯模糊脱敏</div>
    <div class="form-block">
      <label>上传影像：</label>
      <input type="file" id="blurImg" accept="image/*" />
      <div class="form-inline">
        <label>模糊半径 r_b(px)：</label>
        <input type="range" id="blurR" min="0" max="25" value="10" oninput="document.getElementById('blurVal').textContent=this.value; applyGaussian()" />
        <span id="blurVal" style="min-width:2em">10</span>
        <button class="btn secondary" onclick="downloadCanvas('blurCanvas','blur_gaussian.png')" id="btnDownloadBlur" disabled>下载脱敏影像</button>
      </div>
      <div class="tip">基于二维高斯卷积核进行模糊保护，卷积核半径可按敏感等级自适应配置。</div>
    </div>
    <canvas id="blurCanvas" width="560" height="340"></canvas>
  </div>

  <!-- 坐标扰动 -->
  <div class="tab-content" id="jitter">
    <div class="section-title">坐标扰动（确定性种子 + 边界约束）</div>
    <div class="form-block">
      <label>上传 CSV（包含 lon,lat 表头）：</label>
      <input type="file" id="csvFile" accept=".csv" />
      <div class="form-inline">
        <label>扰动半径（米）：</label><input type="number" id="jitR" value="30" min="1" max="200" style="width:120px" />
        <label>种子（可重复复现）：</label><input type="text" id="jitSeed" placeholder="留空则自动" style="width:240px" />
        <button class="btn" onclick="doJitter()">执行扰动并下载</button>
      </div>
      <div class="tip">半径随机 r∈[0,R]，θ∈[0,2π)，种子=SHA256(输入或数据ID)，对同一输入可复验；经纬度保持在合法范围。</div>
    </div>
  </div>

  <!-- 时间提醒 -->
  <div class="tab-content" id="calendar">
    <div class="section-title">日历提醒与节点控制（7/1/0 天）</div>
    <div class="form-block">
      <div class="form-inline">
        <label>样例数据名称：</label><input id="calName" placeholder="样例数据A" style="width:220px">
        <label>到期日：</label><input id="calDate" type="date">
        <button class="btn" onclick="addCalendarTask()">添加监控</button>
        <button class="btn ghost" onclick="toggleScheduler(true)">启动调度</button>
        <button class="btn ghost" onclick="toggleScheduler(false)">停止调度</button>
      </div>
      <div class="tip">
        到期前 7 天/1 天/当天触发提醒，并写入台账作为审查、归档或销毁节点。
      </div>
      <table id="calTable"><thead><tr><th>#</th><th>数据</th><th>到期</th><th>状态</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- 台账 -->
  <div class="tab-content" id="ledger">
    <div class="section-title">行为台账与操作记录</div>
    <div class="form-block">
      <div class="form-inline">
        <label>操作对象：</label><input id="lzName" placeholder="2025Q1_遥感样例01" style="width:280px">
        <label>责任人：</label><input id="lzOwner" placeholder="张三" style="width:160px">
        <button class="btn" onclick="addLedger('manual')">记录行为</button>
        <button class="btn ghost" onclick="verifyLedger()">校验完整性</button>
        <button class="btn warn" onclick="clearLedger()">清空台账</button>
      </div>
      <div id="ledgerTip" class="tip">
        采用哈希链结构记录全流程行为，支持完整性校验和断链检测。
      </div>
      <table id="ledgerTable"><thead><tr><th>#</th><th>对象</th><th>责任人</th><th>时间</th><th>prev</th><th>curr</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- 标准映射 -->
  <div class="tab-content" id="standard">
    <div class="section-title">标准映射与国标对齐模块</div>
    <div class="form-block">
      <div class="form-inline">
        <input id="kwInput" placeholder="关键词（如：油田 / 饮用水水源地 / 湿地 / 土地利用现状）" style="width:320px">
        <button class="btn" onclick="runMapping()">计算映射</button>
      </div>
      <div id="mapOut" class="tip">
        面向自然资源场景，将输入关键词在“绝密/机密/内部”三类标准之间进行打分映射，
        重点考虑战略能源、重要水源地、生态红线等要素。
      </div>
      <table id="mapTbl"><thead><tr><th>候选标准等级</th><th>语义</th><th>密级</th><th>关键词</th><th>总分</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- 区块链存证 -->
  <div class="tab-content" id="blockchain">
    <div class="section-title">区块链存证与链路安全模块</div>
    <div class="form-block">
      <label>存证内容：</label>
      <input id="bcInput" placeholder="输入要存证的文本" />
      <div class="form-inline">
        <button class="btn" onclick="doHash()">生成 SHA-256</button>
        <input id="bcHash" readonly placeholder="摘要显示在此处" />
      </div>
      <div class="tip">
        前端计算摘要以模拟区块链存证流程，真实系统可将摘要上链获取交易编号，并结合链路加密与权限门控形成闭环安全体系。
      </div>
    </div>
  </div>

</div>

<div class="footer">© 2025 自然资源敏感数据合规平台 </div>

<script>
/* ========= 标签页切换 ========= */
function showTab(evt,id){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-tabs a').forEach(a=>a.classList.remove('active'));
  evt.currentTarget.classList.add('active');
  window.scrollTo(0,0);
}

/* ========= 公共工具 ========= */
const enc = new TextEncoder();
async function sha256Hex(str){
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function resLevel(val){const m={'0.3':1,'1':2,'5':3,'10':4,'30':5};return m[String(val)]??5;}
function permit(u,c){return (c==='CN'||c==='US') && u===1 ? 1 : 0;}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function getSelInt(id){return parseInt(document.getElementById(id).value,10)||0;}
function getSelVal(id){return document.getElementById(id).value;}

/* ========= Permit 门禁 ========= */
function updatePermit(){
  const c = getSelVal('selCountry');
  const u = getSelInt('selAuth');
  const ok = permit(u,c);
  document.getElementById('permitBadge').textContent = `Permit: ${u? '已认证':'未认证'} / ${c||'-'} → ${ok? '允许':'拒绝'}`;
  document.getElementById('btnDownloadBlur').disabled = !ok;
}
updatePermit();

/* ========= 版本/规则库 ========= */
const CONFIG = {
  ontology:{version:'v1.4.3', items:['geo:sen/001','geo:sen/005','geo:sen/008']},
  rules:[
    {cond:'入库', action:'受控', level:'G', priority:1, enabled:true},
    {cond:'跨域共享', action:'受审计', level:'I', priority:1, enabled:true},
    {cond:'存储期满', action:'归档', level:'C', priority:1, enabled:true}
  ]
};
let CONFIG_HASH_EXPECT = '';

(async function initVersion(){
  const json = JSON.stringify(CONFIG);
  const h = await sha256Hex(json);
  CONFIG_HASH_EXPECT = CONFIG_HASH_EXPECT || h;
  document.getElementById('verText').textContent = CONFIG.ontology.version;
  document.getElementById('verHash').textContent = h.slice(0,16)+'…';
  const ok = (h===CONFIG_HASH_EXPECT);
  document.getElementById('verStatus').innerHTML = ok ? '<span class="ok">版本校验通过</span>' : '<span class="err">版本不一致，已禁止执行</span>';
  renderRuleTable();
})();

let RULE_ENGINE_ON = false;
function toggleRuleEngine(on){ RULE_ENGINE_ON = !!on; document.getElementById('ruleState').textContent = RULE_ENGINE_ON ? '已启用' : '未启用'; }

function renderRuleTable(){
  const tb = document.querySelector('#ruleTable tbody');
  tb.innerHTML='';
  CONFIG.rules.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.cond}</td><td>${r.action}</td><td>${r.level}</td><td>${r.priority}</td><td>${r.enabled? '是':'否'}</td>`;
    tb.appendChild(tr);
  });
}

/* ========= 分级判定 ========= */
function doJudge(){
  if(!RULE_ENGINE_ON){ alert('请先在“规则库/版本校验”中启用规则引擎'); return; }
  const rsel = getSelVal('resSel'), ssel = getSelInt('sensSel');
  const Rs = resLevel(rsel);
  const R = Rs*ssel;
  const T = parseInt(document.getElementById('thresh').value,10)||9;
  const pass = (R<T);
  const txt = pass? '可控流通' : '禁止流通';
  document.getElementById('judgeOut').textContent = `R=${R} (T=${T}) → ${txt}`;
}

/* ========= 高斯卷积 ========= */
let blurImg = null;
const blurCanvas = document.getElementById('blurCanvas'), bctx = blurCanvas.getContext('2d');
document.getElementById('blurImg').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f); const img = new Image();
  img.onload = ()=>{ blurImg = img; drawImageFit(); applyGaussian(); URL.revokeObjectURL(url); };
  img.src = url;
});
function drawImageFit(){
  bctx.clearRect(0,0,blurCanvas.width,blurCanvas.height);
  if(!blurImg) return;
  const sw=blurImg.width, sh=blurImg.height, cw=blurCanvas.width, ch=blurCanvas.height;
  const sc=Math.min(cw/sw, ch/sh), dw=Math.floor(sw*sc), dh=Math.floor(sh*sc), dx=Math.floor((cw-dw)/2), dy=Math.floor((ch-dh)/2);
  bctx.drawImage(blurImg, dx, dy, dw, dh);
}
function gaussianKernel(rb){
  const sigma = Math.max(0.1, rb/3);
  const r = Math.max(0, Math.floor(rb));
  const size = 2*r+1;
  const k = new Array(size*size);
  let sum=0, idx=0;
  for(let y=-r;y<=r;y++){
    for(let x=-r;x<=r;x++){
      const val = Math.exp(-(x*x+y*y)/(2*sigma*sigma))/(2*Math.PI*sigma*sigma);
      k[idx++]=val; sum+=val;
    }
  }
  for(let i=0;i<k.length;i++) k[i]/=sum;
  return {k, r, size};
}
function applyGaussian(){
  const rb = parseInt(document.getElementById('blurR').value,10);
  const ok = permit(getSelInt('selAuth'), getSelVal('selCountry'));
  document.getElementById('btnDownloadBlur').disabled = !ok;
  if(!blurImg){ return; }
  // 取当前画布像素
  drawImageFit();
  const imgData = bctx.getImageData(0,0,blurCanvas.width, blurCanvas.height);
  const src = imgData.data;
  const out = new Uint8ClampedArray(src.length);
  const {k, r, size} = gaussianKernel(rb);
  const w = blurCanvas.width, h = blurCanvas.height;
  // 卷积
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      let rsum=0,gsum=0,bsum=0,asum=0, idxK=0;
      for(let j=-r;j<=r;j++){
        const yy = clamp(y+j,0,h-1);
        for(let i=-r;i<=r;i++){
          const xx = clamp(x+i,0,w-1);
          const idx = (yy*w+xx)*4;
          const weight = k[idxK++];
          rsum += src[idx]*weight;
          gsum += src[idx+1]*weight;
          bsum += src[idx+2]*weight;
          asum += src[idx+3]*weight;
        }
      }
      const o = (y*w+x)*4;
      out[o] = rsum; out[o+1]=gsum; out[o+2]=bsum; out[o+3]=asum;
    }
  }
  for(let i=0;i<src.length;i++) src[i]=out[i];
  bctx.putImageData(imgData,0,0);
}

/* ========= CSV 坐标扰动 ========= */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const head = lines[0].split(',').map(s=>s.trim());
  const lonIdx = head.findIndex(h=>h.toLowerCase()==='lon');
  const latIdx = head.findIndex(h=>h.toLowerCase()==='lat');
  if(lonIdx<0 || latIdx<0) throw new Error('CSV 需包含 lon,lat 表头');
  const rows = lines.slice(1).map(l=>l.split(','));
  return {head,lonIdx,latIdx,rows};
}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
function seedToInt(s){let h=0;for(let i=0;i<s.length;i++){h=(h*131 + s.charCodeAt(i))>>>0;}return h||0x9e3779b9;}
function metersToDeg(lat,meters){const dLat = meters/111320; const dLon = meters/(111320*Math.cos(lat*Math.PI/180)); return {dLat,dLon};}

async function doJitter() {
  try {
    const file = document.getElementById('csvFile').files[0];
    if (!file) {
      alert('请选择 CSV 文件');
      return;
    }

    const c = getSelVal('selCountry');
    const u = getSelInt('selAuth');
    if (!permit(u, c)) {
      alert('Permit 拒绝：请在首页选择 CN/US 且设置为“已认证”');
      return;
    }

    const Rm = parseFloat(document.getElementById('jitR').value) || 30;
    const seedInput = document.getElementById('jitSeed').value.trim();
    const text = await file.text();

    let parsed;
    try {
      parsed = parseCSV(text);
    } catch (e) {
      alert('CSV 解析失败：' + e.message + '\n请确认首行表头包含 lon,lat 两列。');
      return;
    }
    const { head, lonIdx, latIdx, rows } = parsed;

    const basis = seedInput || (file.name + rows.length);
    const seedHex = await sha256Hex(basis);
    const rng = mulberry32(seedToInt(seedHex.slice(0, 8)));

    const out = [head.join(',')];

    rows.forEach(cols => {
      const lon = parseFloat(cols[lonIdx]);
      const lat = parseFloat(cols[latIdx]);
      if (isNaN(lon) || isNaN(lat)) {
        out.push(cols.join(','));
        return;
      }

      const { dLat, dLon } = metersToDeg(lat, Rm);
      const r = rng();
      const theta = rng() * 2 * Math.PI;
      const lon2 = clamp(lon + dLon * r * Math.cos(theta), -180, 180);
      const lat2 = clamp(lat + dLat * r * Math.sin(theta),  -85,  85);

      const cc = cols.slice();
      cc[lonIdx] = lon2.toFixed(7);
      cc[latIdx] = lat2.toFixed(7);
      out.push(cc.join(','));
    });

    const csvText = '\uFEFF' + out.join('\n'); // 加 BOM，Excel 更易识别 UTF-8
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'jittered.csv';
    a.click();
  } catch (err) {
    console.error(err);
    alert('执行扰动时发生错误：' + err.message);
  }
}

/* ========= 时间提醒 ========= */
const CAL = [];
function addCalendarTask(){
  const name = document.getElementById('calName').value.trim();
  const d = document.getElementById('calDate').value;
  if(!name||!d){ alert('请填写名称与到期日'); return; }
  CAL.push({name, due:new Date(d+'T00:00:00Z'), state:'监控中'});
  renderCalendar();
}
let SCH = null;
function toggleScheduler(on){
  if(on){
    if(SCH) return;
    SCH = setInterval(scanCalendar, 2000);
    alert('调度已启动（2秒扫描一次，演示用途）');
  }else{
    if(SCH){ clearInterval(SCH); SCH=null; alert('调度已停止'); }
  }
}
function renderCalendar(){
  const tb = document.querySelector('#calTable tbody');
  tb.innerHTML='';
  CAL.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.due.toISOString().slice(0,10)}</td><td>${r.state}</td>`;
    tb.appendChild(tr);
  });
}
async function scanCalendar(){
  const now = new Date();

  for(const r of CAL){
    const ms   = r.due - now;
    const days = Math.floor(ms/(1000*3600*24));

    if(days <= 7 && r.state === '监控中'){
      r.state = '已提醒(7天)';
      await addLedger('remind7', r.name);
      alert(`[提醒-7天] ${r.name}`);
      continue;
    }

    if(days <= 1 && (r.state === '监控中' || r.state === '已提醒(7天)')){
      r.state = '已提醒(1天)';
      await addLedger('remind1', r.name);
      alert(`[提醒-1天] ${r.name}`);
      continue;
    }

    if(days <= 0 && r.state !== '到期处理'){
      r.state = '到期处理';
      await addLedger('due', r.name);
      alert(`[到期] ${r.name}：请执行归档/销毁`);
      continue;
    }
  }

  renderCalendar();
}

/* ========= 台账（哈希链） ========= */
function getLedger(){ try{return JSON.parse(localStorage.getItem('ledger_chain')||'[]')}catch{ return [] } }
function setLedger(arr){ localStorage.setItem('ledger_chain', JSON.stringify(arr)); renderLedger(); }

async function addLedger(type = 'manual', obj = '') {
  const name  = obj || document.getElementById('lzName').value.trim() || '(未命名)';
  const owner = document.getElementById('lzOwner').value.trim() || 'system';
  const t     = new Date().toISOString();

  const arr   = getLedger();
  const prev  = arr.length > 0 ? arr[arr.length - 1].curr : '';

  const payload   = `${type}|${name}|${owner}|${t}`;
  const currFull  = await sha256Hex(prev + payload);
  const currShort = currFull.slice(0, 10);

  arr.push({
    type,
    name,
    owner,
    t,
    prev: prev || '-',
    curr: currShort
  });

  setLedger(arr);
}

function renderLedger(){
  const tb = document.querySelector('#ledgerTable tbody');
  tb.innerHTML='';
  getLedger().forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.owner}</td><td>${r.t.replace('T',' ').replace('Z','')}</td><td>${r.prev||'-'}</td><td>${r.curr}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('ledgerTip').textContent = `记录数：${getLedger().length}`;
}

async function verifyLedger() {
  const arr = getLedger();
  if (!arr.length) {
    alert('当前台账为空，无需校验。');
    return;
  }

  let prev = '';

  for (const r of arr) {
    const type = r.type || 'manual';
    const rec  = `${type}|${r.name}|${r.owner}|${r.t}`;
    const curr = (await sha256Hex(prev + rec)).slice(0, 10);

    if (curr !== r.curr) {
      alert('校验失败：发现断链/篡改');
      return;
    }

    prev = r.curr;
  }

  alert('校验通过：台账链完整');
}

function clearLedger(){ if(confirm('清空台账？')) setLedger([]); }
renderLedger();

/* ========= 标准映射（自然资源场景规则） ========= */
/**
 * 规则设计（面向自然地理资源）：
 * - 绝密：国家级能源基地、战略油气田、稀有金属矿、饮用水一类水源地、生态红线核心区等；
 * - 机密：大中型水库、水电站、一般油气田/煤矿、重要湿地、基本农田保护区等；
 * - 内部：土地利用现状、一般基础地理、普查、示例/教学数据、公开数据等。
 * 打分：score = 0.3*语义 + 0.3*密级 + 0.4*关键词匹配
 */
const LEVEL_CONFIG = [
  {
    level: '绝密',
    baseSemantic: 0.92,
    baseSecrecy: 1.00,
    keywords: [
      '国家级能源基地','战略油气田','大型油田','深水油气','稀有金属矿',
      '重要稀土','饮用水水源地','一类水源地','备用水源地',
      '生态红线核心区','自然保护区核心区','重点物种栖息地'
    ]
  },
  {
    level: '机密',
    baseSemantic: 0.80,
    baseSecrecy: 0.78,
    keywords: [
      '大中型水库','水电站','油田','气田','煤矿','露天矿','矿区',
      '重要湿地','自然保护区缓冲区','重点生态功能区',
      '基本农田保护区','永久基本农田','重要通道','管道','输油管线','输气管线'
    ]
  },
  {
    level: '内部',
    baseSemantic: 0.60,
    baseSecrecy: 0.40,
    keywords: [
      '土地利用现状','土地利用图','土地利用','基础地理','遥感解译成果',
      '普查','统计','示例','样例','教学数据','公开数据','开放数据'
    ]
  }
];

// 让“关键词匹配”权重更高
const WEIGHT = { semantic: 0.3, secrecy: 0.3, kw: 0.4 };

function kwMatchScore(input, list){
  if(!input) return 0.2;
  let hit = 0;
  for(const k of list){
    if(input.includes(k)){
      hit = 1.0;
      break;
    }
  }
  return hit || 0.2;
}

function runMapping(){
  const kw = document.getElementById('kwInput').value.trim();
  const tb = document.querySelector('#mapTbl tbody');
  tb.innerHTML='';

  let best = null;
  LEVEL_CONFIG.forEach(cfg=>{
    const sSemantic = cfg.baseSemantic;
    const sSecrecy  = cfg.baseSecrecy;
    const sKw       = kwMatchScore(kw, cfg.keywords);
    const score     = WEIGHT.semantic*sSemantic + WEIGHT.secrecy*sSecrecy + WEIGHT.kw*sKw;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${cfg.level}</td>
                    <td>${sSemantic.toFixed(2)}</td>
                    <td>${sSecrecy.toFixed(2)}</td>
                    <td>${sKw.toFixed(2)}</td>
                    <td>${score.toFixed(2)}</td>`;
    tb.appendChild(tr);

    if(!best || score > best.score){
      best = { level: cfg.level, score };
    }
  });

  // ★ 特殊规则：凡是包含“土地利用”的，一律优先归为“内部” ★
  if (kw && kw.includes('土地利用')) {
    best = { level: '内部', score: 0.95 };
  }

  if(!kw){
    document.getElementById('mapOut').textContent =
      '未输入关键词时，系统仅依据基础语义与密级属性给出参考得分，需结合具体业务场景人工判定。';
  }else{
    document.getElementById('mapOut').textContent =
      `映射结果：${best.level}（score=${best.score.toFixed(2)}），适用于自然资源数据在“高/较高/一般”敏感等级与国标密级之间的对齐参考。`;
  }
}

/* ========= 区块链存证 ========= */
async function doHash(){
  const v=(document.getElementById('bcInput').value||'').trim();
  if(!v) return;
  document.getElementById('bcHash').value = await sha256Hex(v);
}
</script>
</body>
</html>
