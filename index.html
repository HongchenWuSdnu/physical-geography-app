<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>自然资源敏感分级合规平台</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    body{font-family:"Segoe UI",Arial,Helvetica,sans-serif;background:#f6f8fb;margin:0}
    header{background:#fff;border-bottom:1px solid #e6e9ee}
    .nav{display:flex;align-items:center;max-width:1260px;margin:0 auto;padding:0 24px}
    .nav-logo{font-weight:700;color:#165ba6;font-size:1.12em;margin-right:28px;display:flex;align-items:center}
    .nav-logo img{height:22px;margin-right:8px}
    .nav-tabs{display:flex;flex:1}
    .nav-tabs a{display:block;color:#165ba6;text-decoration:none;padding:18px 18px 12px;border-bottom:3px solid transparent;transition:.17s;margin-right:4px;font-weight:600}
    .nav-tabs a.active,.nav-tabs a:hover{border-bottom:3px solid #f44336;background:#f7f9fa;color:#f44336}
    .container{max-width:1120px;margin:28px auto;background:#fff;border-radius:12px;box-shadow:0 2px 12px #0001;padding:24px 24px 28px;min-height:520px}
    .tab-content{display:none}.tab-content.active{display:block}
    .section-title{font-size:1.22em;font-weight:700;color:#165ba6;margin:1em 0 .5em}
    .form-block{background:#f3f6fa;border-radius:10px;padding:14px 16px;margin:12px 0}
    .form-block label{display:block;font-weight:600;margin:12px 0 6px}
    .form-block input,.form-block select,.form-block button,.form-block textarea{font-size:1em}
    .form-block input,.form-block select,.form-block textarea{width:100%;padding:9px 12px;border:1px solid #d2dbe5;border-radius:8px;box-sizing:border-box}
    .form-inline{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:#165ba6;color:#fff;border:none;border-radius:8px;padding:9px 18px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#00a884}.btn.warn{background:#f44336}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tip{color:#7b8696;font-size:.96em;margin-top:6px}
    .matrix{margin-top:10px;border:1px solid #e2e7ef;border-radius:8px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e2e7ef;padding:8px 10px;text-align:center}
    th{background:#f1f5fb}
    .allow{background:#e7fbe9;color:#09740a;font-weight:700}
    .forbid{background:#ffeaea;color:#d32f2f;font-weight:700}
    .preview{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    canvas,.img-box{border:1px dashed #cfd7e6;border-radius:10px;max-width:100%;background:#fff}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 300px}
    .footer{color:#7d8697;font-size:.95em;text-align:center;margin:18px 0}
    code.kbd{background:#eef3f8;border:1px solid #dde3ec;border-radius:6px;padding:1px 6px}
  </style>
</head>
<body>
<header>
  <nav class="nav">
    <div class="nav-logo">
      <img src="https://cdn-icons-png.flaticon.com/512/3429/3429626.png" alt="logo" />
      自然资源敏感分级合规平台（交互版）
    </div>
    <div class="nav-tabs">
      <a href="#home" class="active" onclick="showTab(event,'home')">平台首页</a>
      <a href="#judge" onclick="showTab(event,'judge')">分级判定/自动脱敏</a>
      <a href="#blur" onclick="showTab(event,'blur')">高斯模糊脱敏</a>
      <a href="#jitter" onclick="showTab(event,'jitter')">坐标扰动脱敏</a>
      <a href="#ledger" onclick="showTab(event,'ledger')">台账与销毁登记</a>
      <a href="#standard" onclick="showTab(event,'standard')">标准映射/国标对齐</a>
      <a href="#blockchain" onclick="showTab(event,'blockchain')">区块链存证</a>
    </div>
  </nav>
</header>

<div class="container">

  <!-- 首页 -->
  <div class="tab-content active" id="home">
    <div class="section-title">平台简介</div>
    <ul>
      <li>支持影像上传预览、前端高斯模糊、CSV 坐标扰动脱敏、分级判定、台账登记与本地存证哈希演示。</li>
      <li>纯前端实现（HTML + JS + Canvas + Web Crypto），无需后端即可演示核心交互流程。</li>
      <li>建议使用现代浏览器（Chrome/Edge/Firefox）。如需接入后端 API，可在此基础上继续对接。</li>
    </ul>
  </div>

  <!-- 分级判定/自动脱敏 -->
  <div class="tab-content" id="judge">
    <div class="section-title">一键分级判定与自动脱敏（判定演示）</div>
    <div class="row">
      <div class="col">
        <div class="form-block">
          <label>上传遥感影像 (jpg/png)：</label>
          <input type="file" id="judgeImg" accept="image/*" />
          <label>空间分辨率(m)：</label>
          <select id="resSel">
            <option>0.3</option><option>1</option><option>5</option><option>10</option><option>30</option>
          </select>
          <label>敏感等级（高 / 中 / 低）：</label>
          <select id="sensSel">
            <option value="1">低</option>
            <option value="2">中</option>
            <option value="3">高</option>
          </select>
          <button class="btn" onclick="doJudge()">一键判定</button>
          <div id="judgeResult" class="tip"></div>
        </div>
      </div>
      <div class="col">
        <div class="section-title" style="margin-top:0">分级判定矩阵（示例）</div>
        <div class="matrix">
          <table>
            <tr>
              <th>分辨率 \\ 敏感等级</th>
              <th>低</th>
              <th>中</th>
              <th>高</th>
            </tr>
            <tr>
              <td>0.3</td>
              <td class="allow">可控流通</td>
              <td class="allow">可控流通</td>
              <td class="forbid">禁止流通</td>
            </tr>
            <tr>
              <td>1</td>
              <td class="allow">可控流通</td>
              <td class="allow">可控流通</td>
              <td class="forbid">禁止流通</td>
            </tr>
            <tr>
              <td>5</td>
              <td class="allow">可控流通</td>
              <td class="allow">可控流通</td>
              <td class="allow">可控流通</td>
            </tr>
          </table>
        </div>
        <div class="tip">
          阈值 T = 6，R = 分辨率等级 × 敏感等级（低=1、中=2、高=3）。R ≥ 6 判定为“禁止流通”，否则为“可控流通”。
        </div>
      </div>
    </div>
  </div>

  <!-- 高斯模糊脱敏（前端 Canvas 演示） -->
  <div class="tab-content" id="blur">
    <div class="section-title">遥感影像高斯模糊（前端演示）</div>
    <div class="form-block">
      <label>上传遥感影像：</label>
      <input type="file" id="blurImg" accept="image/*" />
      <label>模糊半径(px)：</label>
      <div class="form-inline">
        <input type="range" id="blurR" min="0" max="25" value="8" oninput="document.getElementById('blurVal').textContent=this.value; redrawBlur()" />
        <span id="blurVal" style="min-width:2em;display:inline-block">8</span>
        <button class="btn secondary" onclick="downloadCanvas('blurCanvas','blurred.png')">下载脱敏影像</button>
      </div>
    </div>
    <div class="preview">
      <canvas id="blurCanvas" width="560" height="340"></canvas>
    </div>
    <div class="tip">说明：使用 Canvas 2D 的 <code class="kbd">context.filter='blur(px)'</code> 实时模糊（演示用途）。</div>
  </div>

  <!-- 坐标扰动脱敏（CSV lon,lat） -->
  <div class="tab-content" id="jitter">
    <div class="section-title">坐标扰动脱敏（CSV lon,lat）</div>
    <div class="form-block">
      <label>上传 CSV（需包含表头 <b>lon,lat</b>）：</label>
      <input type="file" id="csvFile" accept=".csv" />
      <label>扰动半径（米）：</label>
      <div class="form-inline">
        <input type="range" id="jitterR" min="1" max="200" value="30" oninput="document.getElementById('jitVal').textContent=this.value" />
        <span id="jitVal" style="min-width:2em;display:inline-block">30</span>
        <button class="btn" onclick="doJitter()">执行扰动并下载</button>
      </div>
    </div>
    <div class="tip">算法：<code class="kbd">x' = x + r·cosθ</code>，<code class="kbd">y' = y + r·sinθ</code>（r≤设定半径，θ∈[0,2π)）。坐标假定为 WGS84，经纬度近似按米换算演示。</div>
  </div>

  <!-- 台账与销毁登记（localStorage 演示） -->
  <div class="tab-content" id="ledger">
    <div class="section-title">销毁登记与操作台账（本地存储演示）</div>
    <div class="form-block">
      <label>待销毁数据名称：</label>
      <input id="lzName" type="text" placeholder="例如：2025Q1_遥感影像_样例01" />
      <label>责任人：</label>
      <input id="lzOwner" type="text" placeholder="张三" />
      <label>上传销毁截图（可选）：</label>
      <input id="lzShot" type="file" accept="image/*" />
      <div class="form-inline">
        <button class="btn" onclick="addLedger()">登记销毁</button>
        <button class="btn secondary" onclick="clearLedger()">清空台账</button>
      </div>
    </div>
    <div class="section-title" style="margin-top:18px">台账记录</div>
    <table id="ledgerTable">
      <thead><tr><th>#</th><th>名称</th><th>责任人</th><th>时间</th><th>截图(可选)</th><th>哈希</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="tip">说明：示例将记录保存在浏览器 <code class="kbd">localStorage</code> 中，真实系统请写入后端数据库并上链存证。</div>
  </div>

  <!-- 标准映射/国标对齐（演示） -->
  <div class="tab-content" id="standard">
    <div class="section-title">敏感关键词 - 国标等级映射（演示）</div>
    <div class="form-block">
      <div class="form-inline">
        <input id="kwInput" placeholder="输入敏感关键词，如：战略指挥工程" />
        <button class="btn" onclick="lookupStd()">查询国标等级</button>
      </div>
      <div id="stdOut" class="tip"></div>
    </div>
    <table>
      <tr><th>敏感关键词</th><th>国标等级</th><th>说明</th></tr>
      <tr><td>战略指挥工程</td><td>A</td><td>高敏核心</td></tr>
      <tr><td>密集居民区</td><td>B</td><td>重要</td></tr>
    </table>
  </div>

  <!-- 区块链存证（前端 SHA-256 演示） -->
  <div class="tab-content" id="blockchain">
    <div class="section-title">区块链存证与安全链路（演示）</div>
    <div class="form-block">
      <label>模拟存证内容：</label>
      <input id="bcInput" placeholder="输入要存证的文本内容" />
      <div class="form-inline">
        <button class="btn" onclick="doHash()">生成SHA-256摘要</button>
        <input id="bcHash" readonly placeholder="摘要将显示在此处" />
      </div>
      <div class="tip">说明：这里演示本地计算哈希作为“区块编号”，真实系统应提交到链上并返回交易/区块ID。</div>
    </div>
  </div>

</div>

<div class="footer">© 2025 自然资源敏感数据合规平台 | 纯前端交互演示</div>

<script>
  /* —— 导航 —— */
  function showTab(evt, id){
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-tabs a').forEach(a=>a.classList.remove('active'));
    evt.currentTarget.classList.add('active');
    history.replaceState(null, '', '#'+id);
    window.scrollTo(0,0);
  }

  /* —— 分级判定 —— */
  function resLevel(val){
    // 将分辨率映射为等级：0.3→1, 1→2, 5→3, 10→4, 30→5
    const m = {'0.3':1,'1':2,'5':3,'10':4,'30':5};
    return m[String(val)] ?? 5;
  }

  function doJudge(){
    const rsel = document.getElementById('resSel').value;
    const ssel = parseInt(document.getElementById('sensSel').value,10); // 1低 2中 3高
    const Rs = resLevel(rsel);
    const R = Rs * ssel;
    const T = 6; // 三档敏感等级示例阈值
    const cls = (R >= T) ? 'forbid' : 'allow';
    const txt = (R >= T) ? '禁止流通' : '可控流通';
    const sensText = {1:'低',2:'中',3:'高'}[ssel] || '';
    document.getElementById('judgeResult').innerHTML =
      `分辨率等级=${Rs}，敏感等级=${sensText}，耦合指数 R=${R}，判定：<b class="${cls}">${txt}</b>`;
  }

  /* —— 高斯模糊（Canvas filter 演示） —— */
  let blurImgObj = null;
  const blurCanvas = document.getElementById('blurCanvas');
  const bctx = blurCanvas.getContext('2d');
  document.getElementById('blurImg').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image(); img.onload = ()=>{ blurImgObj = img; redrawBlur(); URL.revokeObjectURL(url); };
    img.src = url;
  });
  function redrawBlur(){
    if(!blurImgObj){ bctx.clearRect(0,0,blurCanvas.width,blurCanvas.height); return; }
    const r = parseInt(document.getElementById('blurR').value,10);
    bctx.clearRect(0,0,blurCanvas.width,blurCanvas.height);
    bctx.filter = `blur(${r}px)`;
    // 自适应居中绘制
    const sw = blurImgObj.width, sh = blurImgObj.height;
    const cw = blurCanvas.width, ch = blurCanvas.height;
    const scale = Math.min(cw/sw, ch/sh);
    const dw = Math.max(1, Math.floor(sw*scale)), dh = Math.max(1, Math.floor(sh*scale));
    const dx = Math.floor((cw-dw)/2), dy = Math.floor((ch-dh)/2);
    bctx.drawImage(blurImgObj, dx, dy, dw, dh);
    bctx.filter = 'none';
  }
  function downloadCanvas(canvasId, filename){
    const url = document.getElementById(canvasId).toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  }

  /* —— CSV 坐标扰动 —— */
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const head = lines[0].split(',').map(s=>s.trim());
    const lonIdx = head.findIndex(h=>h.toLowerCase()==='lon');
    const latIdx = head.findIndex(h=>h.toLowerCase()==='lat');
    if(lonIdx<0 || latIdx<0) throw new Error('CSV 需包含 lon,lat 表头');
    const rows = lines.slice(1).map(l=>l.split(','));
    return {head,lonIdx,latIdx,rows};
  }
  function jitterLonLat(lon,lat,meters){
    // 近似换算：1度纬度≈111320米；经度按纬度缩放
    const dLat = meters/111320;
    const dLon = meters/(111320*Math.cos(lat*Math.PI/180));
    const r = Math.random()*1; // 0~1
    const R = r*1; // 归一化半径比例
    const theta = Math.random()*2*Math.PI;
    return [lon + dLon*R*Math.cos(theta), lat + dLat*R*Math.sin(theta)];
  }
  function doJitter(){
    const file = document.getElementById('csvFile').files[0];
    if(!file){ alert('请先选择 CSV 文件'); return; }
    const Rm = parseFloat(document.getElementById('jitterR').value);
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const {head,lonIdx,latIdx,rows} = parseCSV(reader.result);
        const out = [head.join(',')];
        rows.forEach(cols=>{
          const lon = parseFloat(cols[lonIdx]), lat = parseFloat(cols[latIdx]);
          const [lon2,lat2] = jitterLonLat(lon,lat,Rm);
          const cc = cols.slice(); cc[lonIdx]=lon2.toFixed(7); cc[latIdx]=lat2.toFixed(7);
          out.push(cc.join(','));
        });
        const blob = new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download='jittered.csv'; a.click();
      }catch(e){ alert('处理失败：'+e.message); }
    };
    reader.readAsText(file);
  }

  /* —— 台账（localStorage） —— */
  function getLedger(){ try{return JSON.parse(localStorage.getItem('ledger')||'[]')}catch{ return [] } }
  function setLedger(arr){ localStorage.setItem('ledger', JSON.stringify(arr)); renderLedger(); }
  async function hashText(t){
    const enc = new TextEncoder().encode(t);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function addLedger(){
    const name = document.getElementById('lzName').value.trim();
    const owner = document.getElementById('lzOwner').value.trim();
    const shot = document.getElementById('lzShot').files[0];
    if(!name||!owner){ alert('请填写名称与责任人'); return; }
    const t = new Date().toISOString();
    let shotUrl = '';
    if(shot){ shotUrl = URL.createObjectURL(shot); }
    const hash = await hashText(name+'|'+owner+'|'+t);
    const arr = getLedger();
    arr.push({name,owner,t,shotUrl,hash});
    setLedger(arr);
    document.getElementById('lzName').value=''; document.getElementById('lzOwner').value=''; document.getElementById('lzShot').value='';
  }
  function renderLedger(){
    const tbody = document.querySelector('#ledgerTable tbody'); tbody.innerHTML='';
    getLedger().forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.owner}</td><td>${r.t.replace('T',' ').replace('Z','')}</td>
                      <td>${r.shotUrl?`<a href="${r.shotUrl}" target="_blank">查看</a>`:'-'}</td>
                      <td>${r.hash.slice(0,16)}…</td>`;
      tbody.appendChild(tr);
    });
  }
  function clearLedger(){ if(confirm('确认清空本地台账？')) setLedger([]); }
  renderLedger();

  /* —— 标准映射（小演示） —— */
  const STD_MAP = {'战略指挥工程':'A','密集居民区':'B','小型水库':'C'};
  function lookupStd(){
    const kw = document.getElementById('kwInput').value.trim();
    if(!kw) return (document.getElementById('stdOut').textContent='请输入关键词');
    const lvl = STD_MAP[kw] || '（未匹配）';
    document.getElementById('stdOut').textContent = `查询：${kw} → 国标等级：${lvl}`;
  }

  /* —— 区块链存证（前端 SHA-256） —— */
  async function doHash(){
    const v = (document.getElementById('bcInput').value||'').trim();
    if(!v) return;
    const digest = await hashText(v);
    document.getElementById('bcHash').value = digest;
  }

  /* —— 首次根据 URL hash 定位 —— */
  (function initFromHash(){
    const tab = (location.hash||'').slice(1);
    if(tab && document.getElementById(tab)){
      document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.querySelectorAll('.nav-tabs a').forEach(a=>a.classList.remove('active'));
      const link = document.querySelector(`.nav-tabs a[href="#${tab}"]`); if(link) link.classList.add('active');
      window.scrollTo(0,0);
    }
  })();
</script>
</body>
</html>
